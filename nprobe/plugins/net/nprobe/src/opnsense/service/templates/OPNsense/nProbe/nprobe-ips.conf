{% if helpers.exists('OPNsense.nprobe.general.enabled') and OPNsense.nprobe.general.enabled == '1' %}
# Continents: Africa / Asia-Pacific / Europe / North America / South America

### Policy definition ###
{%     set json = '{"policy":{"id":0,"name":"root policy rule","default_marker":"pass","ip":[' %}
{%     set net_namespace = namespace(net="", ctr=0) %}
{%     set cat_namespace = namespace(cat="", ctr=0) %}
{%     set proto_namespace = namespace(proto="", ctr=0) %}
{%     set flow_risk_namespace = namespace(flow_risk="", ctr=0) %}
{%     set country_namespace = namespace(country="", ctr=0) %}
{%     set continent_namespace = namespace(continent="", ctr=0) %}
{# Set the local networks #}
{%     for local_net in OPNsense.nprobe.general.localnet.split(",") %}
{%          if net_namespace.ctr > 0 %}
{%	       set net_namespace.net = net_namespace.net + "," %}
{%	    endif %}
{%	    set net_namespace.net = net_namespace.net + '"' + local_net + '"' %}
{%	    set net_namespace.ctr = net_namespace.ctr + 1 %}
{%     endfor %}
{%     set json = json + net_namespace.net + '],"markers":{"categories":{'%}
{# Set the markers #}
{# Categories #}
{%     for category in OPNsense.nprobe.general.category.split(",") %}
{%     	    if category != '' %}
{%             if cat_namespace.ctr > 0 %}
{%	       	  set cat_namespace.cat = cat_namespace.cat + "," %}
{%	       endif %}
{%	       set cat_namespace.cat = cat_namespace.cat + '"' + category + '":"drop"' %}
{%	       set cat_namespace.ctr = cat_namespace.ctr + 1 %}
{%	    endif %}
{%     endfor %}
{%     set json = json + cat_namespace.cat + '},"protocols":{'%}
{# Protocols #}
{%     for protocol in OPNsense.nprobe.general.protocols.split(",") %}
{%     	    if protocol != '' %}
{%             if proto_namespace.ctr > 0 %}
{%	       	  set proto_namespace.proto = proto_namespace.proto + "," %}
{%	       endif %}
{%	       set proto_namespace.proto = proto_namespace.proto + '"' + protocol + '":"drop"' %}
{%	       set proto_namespace.ctr = proto_namespace.ctr + 1 %}
{%	    endif %}
{%     endfor %}
{%     set json = json + proto_namespace.proto + '},"flow_risk":{'%}
{# Flow Risk #}
{%     for flow_risk in OPNsense.nprobe.general.flowrisks.split(",") %}
{%     	    if flow_risk != '' %}
{%             if flow_risk_namespace.ctr > 0 %}
{%	       	  set flow_risk_namespace.flow_risk = flow_risk_namespace.flow_risk + "," %}
{%	       endif %}
{%	       set flow_risk_namespace.flow_risk = flow_risk_namespace.flow_risk + '"' + flow_risk + '":"drop"' %}
{%	       set flow_risk_namespace.ctr = flow_risk_namespace.ctr + 1 %}
{%	    endif %}
{%     endfor %}
{%     set json = json + flow_risk_namespace.flow_risk + '},"countries":{' %}
{# Countries #}
{%     for country in OPNsense.nprobe.general.countries.split(",") %}
{%     	    if country != '' %}
{%             if country_namespace.ctr > 0 %}
{%	       	  set country_namespace.country = country_namespace.country + "," %}
{%	       endif %}
{%	       set country_namespace.country = country_namespace.country + '"' + country + '":"drop"' %}
{%	       set country_namespace.ctr = country_namespace.ctr + 1 %}
{%	    endif %}
{%     endfor %}
{%     set json = json + country_namespace.country + '},"continents":{'%}
{# Continents #}
{%     for continent in OPNsense.nprobe.general.continents.split(",") %}
{%     	    if continent != '' %}
{%             if continent_namespace.ctr > 0 %}
{%	       	  set continent_namespace.continent = continent_namespace.continent + "," %}
{%	       endif %}
{%	       set continent_namespace.continent = continent_namespace.continent + '"' + continent + '":"drop"' %}
{%	       set continent_namespace.ctr = continent_namespace.ctr + 1 %}
{%	    endif %}
{%     endfor %}
{%     set json = json + continent_namespace.continent %}
{%     set json = json + '}}}}' %}
{{json}}

### GeoIP ###
{ "geoip": { "asn": "/data/dbip-asn-lite-2021-04.mmdb", "city": "/data/dbip-city-lite-2021-04.mmdb" }}
{% endif %}